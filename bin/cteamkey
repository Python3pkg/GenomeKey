#!/usr/bin/env python

import ipdb
import argparse

from cosmos          import session
from cosmos.config   import settings
from cosmos.Workflow import cli

from genomekey.wga_settings        import wga_settings
from genomekey.workflows.pipeline  import Pipeline

session.get_drmaa_native_specification = wga_settings['get_drmaa_native_specification']

###############################
# bam
###############################

def bam(workflow,input_bam,input_bam_list,**kwargs):
    """
    Input file is a bam with properly annotated readgroups.

    """
    input_bams = input_bam_list.read().strip().split('\n') if input_bam_list else []
    if input_bam:
        input_bams.append(input_bam.name)

    if len(input_bams) == 0:
        raise WorkflowException, 'At least 1 BAM input required'

    dag = DAG(ignore_stage_name_collisions=True)

    dag.sequence_(
        Pipeline(workflow,dag,settings,input_bams),
        configure(wga_settings),
        add_run(workflow)
    )
    
###############################
# CLI Configuration
###############################

def main():
    from argparse import RawTextHelpFormatter
    parser = argparse.ArgumentParser(description='WGA')
    subparsers = parser.add_subparsers(title="Commands", metavar="<command>")

    bam_sp = subparsers.add_parser('bam',help="Input is a bam or bam file list",description=bam.__doc__,formatter_class=RawTextHelpFormatter)
    cli.add_workflow_args(bam_sp)
    bam_sp.add_argument('-i', '--input_bam',     type=file,help='A path to a BAM file')
    bam_sp.add_argument('-il','--input_bam_list',type=file,help='A path to a file containing a list of paths to BAMs, separated by newlines')
    bam_sp.set_defaults(func=bam)

    wf,kwargs = cli.parse_args(parser)
    wf.log.info('wga_settings =\n{0}'.format(pprint.pformat(wga_settings,indent=2)))
    kwargs['func'](wf,**kwargs)


if __name__ == '__main__':
    with ipdb.launch_ipdb_on_exception():    
        main()
